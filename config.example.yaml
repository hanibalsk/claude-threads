# claude-threads configuration
# Copy this file to .claude-threads/config.yaml and customize

# Version (do not edit)
version: "0.1.0"

# ============================================================
# Thread Settings
# ============================================================
threads:
  # Maximum concurrent running threads
  max_concurrent: 5

  # Maximum background threads (foreground gets priority)
  max_background: 4

  # Default max turns for automatic mode
  default_max_turns: 80

  # Default timeout in seconds
  default_timeout: 3600

  # Auto-cleanup completed threads after N days
  cleanup_after_days: 7

# ============================================================
# Orchestrator Settings
# ============================================================
orchestrator:
  # Main loop poll interval in seconds
  poll_interval: 1

  # Longer poll interval when system is idle (adaptive polling)
  idle_poll_interval: 10

  # Number of idle ticks before switching to idle poll interval
  idle_threshold: 30

  # Background thread check interval
  background_check_interval: 5

  # Enable scheduled thread wake-up
  enable_scheduling: true

  # Log level: trace, debug, info, warn, error
  log_level: info

# ============================================================
# Orchestrator Control Agent
# ============================================================
orchestrator_control:
  # Enable automatic controller agent spawn
  # When true, orchestrator starts a Claude-based controller agent
  # that monitors, coordinates, and makes intelligent decisions
  enabled: false

  # Auto-spawn PR shepherds when PRs are watched
  auto_spawn_shepherds: true

  # Maximum concurrent shepherd agents
  max_concurrent_shepherds: 5

  # Controller agent mode: 'automatic' or 'interactive'
  # automatic: runs without user interaction
  # interactive: prompts for decisions
  mode: automatic

  # Controller check interval (seconds)
  # How often the controller reviews system state
  check_interval: 60

  # Auto-handle escalations (vs prompting user)
  auto_handle_escalations: false

# ============================================================
# PR Shepherd Settings
# ============================================================
pr_shepherd:
  # Maximum auto-fix attempts per PR before blocking
  max_fix_attempts: 5

  # Seconds between CI status checks when PR is active
  ci_poll_interval: 30

  # Seconds between checks when no active PRs (idle mode)
  idle_poll_interval: 300

  # Seconds to wait after push before checking CI
  push_cooldown: 120

  # Auto-merge PRs when CI passes and approved
  auto_merge: false

# ============================================================
# Blackboard Settings
# ============================================================
blackboard:
  # Event retention in days
  event_retention_days: 7

  # Message retention in days
  message_retention_days: 30

  # Max events per poll
  max_events_per_poll: 100

# ============================================================
# Claude Settings
# ============================================================
claude:
  # Claude CLI command (default: claude)
  command: claude

  # Session timeout in seconds
  session_timeout: 3600

  # Default permission mode for automatic threads
  # Options: acceptEdits, ask
  permission_mode: acceptEdits

# ============================================================
# GitHub Integration
# ============================================================
github:
  # Enable GitHub webhook receiver
  enabled: false

  # Webhook server port
  webhook_port: 31338

  # Webhook secret (set via environment GITHUB_WEBHOOK_SECRET)
  # webhook_secret: ""

  # Events to listen for
  events:
    - pull_request
    - check_run
    - pull_request_review

# ============================================================
# n8n Integration
# ============================================================
n8n:
  # Enable n8n API
  enabled: false

  # API server port
  api_port: 31337

  # API authentication token (set via environment N8N_API_TOKEN)
  # api_token: ""

# ============================================================
# Logging
# ============================================================
logging:
  # Log directory (relative to data dir)
  directory: logs

  # Enable JSON structured logging
  json_enabled: false

  # Max log file size in MB
  max_size_mb: 10

  # Number of log files to keep
  max_files: 5

# ============================================================
# Worktree Settings
# ============================================================
worktrees:
  # Enable worktree isolation for threads
  enabled: true

  # Maximum age of worktrees before cleanup (days)
  max_age_days: 7

  # Auto-cleanup worktrees for completed threads
  auto_cleanup: true

  # Default base branch for new worktrees
  default_base_branch: main

  # Auto-push changes when thread completes
  auto_push: true

# ============================================================
# Merge Strategy Settings
# ============================================================
merge:
  # Strategy when thread completes: 'direct', 'pr', 'none'
  # - direct: Merge worktree branch directly into target branch (single repo)
  # - pr: Create a pull request for review (multi-repo / team workflow)
  # - none: Leave branch as-is, manual merge required
  strategy: pr

  # Target branch for merges (default: main)
  target_branch: main

  # For 'direct' strategy: merge method
  # Options: merge, rebase, squash
  direct_method: merge

  # For 'pr' strategy: auto-merge when CI passes
  pr_auto_merge: false

  # For 'pr' strategy: require approval before auto-merge
  pr_require_approval: true

  # For 'pr' strategy: delete branch after merge
  pr_delete_branch: true

  # Commit message template for squash merges
  # Variables: {thread_name}, {thread_id}, {branch}, {summary}
  squash_message_template: "feat: {thread_name}\n\n{summary}"

  # On merge conflict: 'block', 'resolve', 'notify'
  # - block: Mark thread as blocked, wait for manual resolution
  # - resolve: Spawn conflict resolver agent
  # - notify: Notify user but continue (leave in conflicted state)
  on_conflict: block

# ============================================================
# Port Allocation Settings
# ============================================================
ports:
  # Port allocation mode: 'auto' or 'manual'
  # auto: Dynamically allocate ports from range
  # manual: Use fixed ports configured in n8n.api_port etc.
  allocation: auto

  # Port range for automatic allocation
  range_start: 31340
  range_end: 31399

  # Heartbeat interval in seconds (for registry updates)
  heartbeat_interval: 10

  # Seconds before instance is considered stale
  stale_timeout: 30

# ============================================================
# Work Recovery Settings
# ============================================================
recovery:
  # Enable work recovery (checkpoints)
  enabled: true

  # Checkpoint strategy: 'periodic', 'signals', 'all'
  # - periodic: Create checkpoints at regular intervals
  # - signals: Only on SIGTERM/SIGINT
  # - all: Both periodic and signal-based
  checkpoint_strategy: all

  # Interval for periodic checkpoints (minutes)
  checkpoint_interval_minutes: 5

  # How to preserve uncommitted work: 'diff', 'stash', 'temp_commit'
  # - diff: Store full diff (recommended, portable)
  # - stash: Use git stash (requires clean restore)
  # - temp_commit: Create temporary commit (modifies history)
  preservation_method: diff

  # Auto-recover interrupted threads on orchestrator startup
  auto_recover_on_startup: true

  # Auto-resume interrupted threads (vs publishing event for manual decision)
  auto_resume_interrupted: false

  # Days to keep checkpoints before cleanup
  cleanup_after_days: 14

# ============================================================
# Thread Groups Settings
# ============================================================
thread_groups:
  # Enable thread grouping
  enabled: true

  # Default grouping method: 'time_window', 'epic', 'parent', 'none', 'manual'
  # - time_window: Group threads started within N minutes
  # - epic: Group by epic extracted from thread name
  # - parent: Group by parent thread (for spawned threads)
  # - none/manual: No auto-grouping, use manual ct group add
  default_grouping: time_window

  # Time window size in minutes (for time_window grouping)
  time_window_minutes: 60

  # Default PR strategy for groups: 'individual', 'consolidated'
  # - individual: Each thread creates its own PR (default)
  # - consolidated: Single PR with all thread changes merged
  default_pr_strategy: individual

  # Merge method for consolidated PRs: 'merge', 'rebase', 'squash_all'
  consolidated_merge_method: merge

  # When to create consolidated PR: 'all_complete', 'any_complete', 'manual'
  # - all_complete: Wait for all threads in group to complete
  # - any_complete: Create as threads complete (incremental)
  # - manual: Only via ct group pr command
  consolidated_pr_trigger: all_complete

  # Days to keep completed/abandoned groups before cleanup
  cleanup_after_days: 30

# ============================================================
# Template Settings
# ============================================================
templates:
  # Base directory for templates
  directory: templates

  # Enable template caching
  cache_enabled: true

  # Custom template variables (available in all templates)
  variables:
    project_name: ""
    default_branch: main
